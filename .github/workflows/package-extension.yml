name: Package and Publish Extension

on:
  release:
    types: [published]

jobs:
  package:
    name: Build the extension packages
    runs-on: ubuntu-latest
    
    steps:
    - name: Show context
      run: |
        echo github.event.action = ${{ github.event.action }}
        echo github.event_name = ${{ github.event_name }}
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create Firefox package
      run: |
        # Create temporary directory for Firefox build
        mkdir -p firefox-build
        
        # Copy all required files and directories
        cp -r background firefox-build/
        cp -r content-script firefox-build/
        cp -r css firefox-build/
        cp -r dialog firefox-build/
        cp -r icons firefox-build/
        cp -r options firefox-build/
        cp LICENSE firefox-build/
        cp README.md firefox-build/
        
        # Copy Firefox manifest as manifest.json
        cp manifest_ff.json firefox-build/manifest.json
        
        # Create zip file
        cd firefox-build
        zip -r ../snowtools-firefox-${GITHUB_REF_NAME}.zip .
        cd ..
        
    - name: Create Chromium package
      run: |
        # Create temporary directory for Chromium build
        mkdir -p chromium-build
        
        # Copy all required files and directories
        cp -r background chromium-build/
        cp -r content-script chromium-build/
        cp -r css chromium-build/
        cp -r dialog chromium-build/
        cp -r icons chromium-build/
        cp -r options chromium-build/
        cp LICENSE chromium-build/
        cp README.md chromium-build/
        
        # Copy Chromium manifest as manifest.json
        cp manifest_chromium.json chromium-build/manifest.json
        
        # Create zip file
        cd chromium-build
        zip -r ../snowtools-chromium-${GITHUB_REF_NAME}.zip .
        cd ..
        
    - name: Upload Firefox package
      uses: actions/upload-artifact@v4
      with:
        name: snowtools-firefox-${{ github.ref_name }}
        path: snowtools-firefox-${{ github.ref_name }}.zip
        
    - name: Upload Chromium package
      uses: actions/upload-artifact@v4
      with:
        name: snowtools-chromium-${{ github.ref_name }}
        path: snowtools-chromium-${{ github.ref_name }}.zip
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          snowtools-firefox-${{ github.ref_name }}.zip
          snowtools-chromium-${{ github.ref_name }}.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-stores:
    name: Publish the packages to the stores
    needs: package
    runs-on: ubuntu-latest
    if: github.event.action == 'published'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Firefox package
      uses: actions/download-artifact@v4
      with:
        name: snowtools-firefox-${{ github.ref_name }}
        
    - name: Download Chromium package
      uses: actions/download-artifact@v4
      with:
        name: snowtools-chromium-${{ github.ref_name }}
        
    - name: Publish to Firefox Add-ons
      uses: browser-actions/release-firefox-addon@latest
      with:
        addon-id: ${{ secrets.FIREFOX_ADDON_ID }}
        auth-api-issuer: ${{ secrets.FIREFOX_API_ISSUER }}
        auth-api-secret: ${{ secrets.FIREFOX_API_SECRET }}
        addon-path: snowtools-firefox-${{ github.ref_name }}.zip
        
    - name: Publish to Chrome Web Store
      uses: browser-actions/release-chrome-extension@latest
      with:
        extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
        client-id: ${{ secrets.CHROME_CLIENT_ID }}
        client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
        refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
        extension-path: snowtools-chromium-${{ github.ref_name }}.zip
        
    - name: Publish to Microsoft Edge Add-ons
      uses: browser-actions/release-edge-extension@latest
      with:
        product-id: ${{ secrets.EDGE_PRODUCT_ID }}
        client-id: ${{ secrets.EDGE_CLIENT_ID }}
        client-secret: ${{ secrets.EDGE_CLIENT_SECRET }}
        access-token-url: ${{ secrets.EDGE_ACCESS_TOKEN_URL }}
        extension-path: snowtools-chromium-${{ github.ref_name }}.zip